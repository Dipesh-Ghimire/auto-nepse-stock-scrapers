{% extends 'base_generic.html' %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <div class="card shadow p-4">
                <h1 class="card-title text-center mb-4">{{ company.name }}</h1>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <p><strong>Symbol:</strong> {{ company.symbol }}</p>
                        <p><strong>Sector:</strong> {{ company.sector }}</p>
                        <p><strong>Address:</strong> {{ company.address }}</p>
                        <p><strong>Website:</strong> <a href="{{ company.website }}" target="_blank">{{ company.website }}</a></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Listed Date:</strong> {{ company.listed_date }}</p>
                        <p><strong>Paid-up Capital:</strong> {{ company.paidup_capital }}</p>
                        <p><strong>Listed Shares:</strong> {{ company.listed_shares }}</p>
                        <p><strong>Market Capitalization:</strong> {{ company.market_capitalization }}</p>
                    </div>
                </div>

                <div class="mb-3">
                    <h5><strong>Description:</strong></h5>
                    <p>{{ company.description }}</p>
                </div>

                <div class="d-flex flex-wrap gap-2 mt-4">
                    <!-- View Price History Button -->
                    <a href="{% url 'price_history' company.id %}" class="btn btn-primary">
                        View Price History
                    </a>

                    <!-- Scrape Latest Prices Button -->
                    <button id="scrape-button" class="btn btn-success">
                        Scrape Latest Prices
                    </button>

                    <!-- Predict Future Prices Button -->
                    <button id="predict-button" class="btn btn-warning">
                        Predict Future Prices
                    </button>
                </div>

                <!-- Result Message Section -->
                <div id="scrape-result" class="mt-3 text-success fw-bold"></div>

                <!-- Prediction Result Section -->
                <div id="result" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- jQuery (for Ajax) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function(){
    $('#scrape-button').click(function(){
        $.ajax({
            url: '{% url "scrape_company_prices" company.id %}',
            method: 'GET',
            success: function(response) {
                $('#scrape-result').html(response.message);
            },
            error: function(error) {
                $('#scrape-result').html('Error occurred while scraping.');
            }
        });
    });

    $('#predict-button').click(function(){
        $.ajax({
            url: '/predict-future-prices/{{ company.id }}/',
            method: 'GET',
            success: function(response) {
                if (response.predictions.length > 0) {
                    let tableHtml = `
                        <table class="table table-striped table-bordered mt-4">
                            <thead class="table-dark">
                                <tr>
                                    <th>Date</th>
                                    <th>Predicted Close Price</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
    
                    response.predictions.forEach(function(prediction) {
                        tableHtml += `
                            <tr>
                                <td>${prediction.date}</td>
                                <td>${prediction.predicted_close_price}</td>
                            </tr>
                        `;
                    });
    
                    tableHtml += `
                            </tbody>
                        </table>
                    `;
    
                    $('#result').html(tableHtml);
                } else {
                    $('#result').html('<p class="text-danger">No predictions available.</p>');
                }
            },
            error: function(xhr, status, error) {
                console.log(xhr.responseText);
                $('#result').html('<p class="text-danger">Error occurred: ' + xhr.responseText + '</p>');
            }
        });
    });
    
});
</script>
{% endblock %}
